export function getGitHubCredentials() {
  return {
    token: localStorage.getItem('github_token') || '',
    owner: localStorage.getItem('github_owner') || '',
    repo: localStorage.getItem('github_repo') || ''
  };
}

export function saveGitHubCredentials(token, owner, repo) {
  if (token) localStorage.setItem('github_token', token);
  if (owner) localStorage.setItem('github_owner', owner);
  if (repo) localStorage.setItem('github_repo', repo);
}

export function clearGitHubCredentials() {
  localStorage.removeItem('github_token');
  localStorage.removeItem('github_owner');
  localStorage.removeItem('github_repo');
}

export function hasGitHubCredentials() {
  const { token, owner, repo } = getGitHubCredentials();
  return !!(token && owner && repo);
}

export async function triggerGitHubWorkflow(scenario, workflowFile = 'pagerduty-demo.yml') {
  const { token, owner, repo } = getGitHubCredentials();
  
  if (!token || !owner || !repo) {
    throw new Error('GitHub credentials not configured');
  }

  const payload = scenario.payload.payload;
  const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflowFile}/dispatches`;

  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Accept': 'application/vnd.github+json',
      'Authorization': `Bearer ${token}`,
      'X-GitHub-Api-Version': '2022-11-28',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      ref: 'main',
      inputs: {
        scenario_id: scenario.id,
        scenario_name: scenario.name,
        severity: payload.severity,
        summary: payload.summary,
        trigger_type: 'demo-dashboard'
      }
    })
  });

  if (response.status === 204) {
    return {
      status: 'success',
      message: 'GitHub workflow triggered',
      integration: 'github_actions'
    };
  }

  if (!response.ok) {
    const error = await response.json().catch(() => ({}));
    throw new Error(error.message || `GitHub API error: ${response.status}`);
  }

  return {
    status: 'success',
    message: 'GitHub workflow triggered',
    integration: 'github_actions'
  };
}

export async function createGitHubIssue(scenario) {
  const { token, owner, repo } = getGitHubCredentials();
  
  if (!token || !owner || !repo) {
    throw new Error('GitHub credentials not configured');
  }

  const payload = scenario.payload.payload;
  const url = `https://api.github.com/repos/${owner}/${repo}/issues`;

  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Accept': 'application/vnd.github+json',
      'Authorization': `Bearer ${token}`,
      'X-GitHub-Api-Version': '2022-11-28',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      title: `[Demo Alert] ${payload.summary}`,
      body: `## Demo Scenario: ${scenario.name}\n\n${scenario.description}\n\n### Details\n\n\`\`\`json\n${JSON.stringify(payload.custom_details, null, 2)}\n\`\`\`\n\n---\n*Generated by PagerDuty Demo Dashboard*`,
      labels: ['demo', 'alert', payload.severity]
    })
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({}));
    throw new Error(error.message || `GitHub API error: ${response.status}`);
  }

  const data = await response.json();
  return {
    status: 'success',
    message: 'GitHub issue created',
    issue_number: data.number,
    issue_url: data.html_url,
    integration: 'github_actions'
  };
}
